{"version":3,"sources":["meteor://ðŸ’»app/imports/common/scripts/DateSet.ts","meteor://ðŸ’»app/imports/common/scripts/date.ts","meteor://ðŸ’»app/imports/common/scripts/order.ts","meteor://ðŸ’»app/imports/api/addOns.ts","meteor://ðŸ’»app/imports/api/anomalyTriggers.ts","meteor://ðŸ’»app/imports/api/blocks.js","meteor://ðŸ’»app/imports/api/bundleTypes.js","meteor://ðŸ’»app/imports/api/fulfillmentSettings.js","meteor://ðŸ’»app/imports/api/ingredients.ts","meteor://ðŸ’»app/imports/api/locationSurcharges.ts","meteor://ðŸ’»app/imports/api/mealPlans.js","meteor://ðŸ’»app/imports/api/meals.js","meteor://ðŸ’»app/imports/api/orders.js","meteor://ðŸ’»app/imports/api/portions.ts","meteor://ðŸ’»app/imports/api/promotions.js","meteor://ðŸ’»app/imports/api/surveys.js","meteor://ðŸ’»app/imports/api/timeSlots.js","meteor://ðŸ’»app/imports/server/main.ts","meteor://ðŸ’»app/server/main.js"],"names":[],"mappings":"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","file":"/app.js","sourcesContent":["import * as _ from 'lodash';\nimport { addDays, today, convertToDate } from './date';\n\nexport class DateSet {\n\trules: any = {};\n\n\tstatic rule = {\n\t\tall():boolean {\n\t\t\treturn true;\n\t\t},\n\t\tweekday(weekday): Function {\n\t\t\treturn (testDate: Date): boolean => {\n\t\t\t\treturn testDate.getDay() == weekday;\n\t\t\t};\n\t\t},\n\t\trange(beginDate: Date|string, endDate: Date|string): Function {\n\t\t\tbeginDate = convertToDate(beginDate);\n\t\t\tendDate = convertToDate(endDate);\n\t\t\treturn (testDate: Date): boolean => {\n\t\t\t\treturn testDate >= beginDate && testDate <= endDate;\n\t\t\t};\n\t\t},\n\t\tinvertedRange(beginDate: Date|string, endDate: Date|string): Function {\n\t\t\tbeginDate = convertToDate(beginDate);\n\t\t\tendDate = convertToDate(endDate);\n\t\t\treturn (testDate: Date): boolean => {\n\t\t\t\treturn testDate < beginDate || testDate > endDate;\n\t\t\t};\n\t\t},\n\t\tdate(date): Function {\n\t\t\tdate = convertToDate(date);\n\t\t\treturn (testDate: Date): boolean => {\n\t\t\t\treturn date.valueOf() == testDate.valueOf();\n\t\t\t};\n\t\t},\n\t\tdayOfYear(dayOfYear: string): Function {\n\t\t\tvar parts = dayOfYear.split('-');\n\t\t\tvar month = parseInt(parts[0]);\n\t\t\tvar day = parseInt(parts[1]);\n\t\t\treturn (testDate: Date): boolean => {\n\t\t\t\treturn testDate.getDate() == day && (testDate.getMonth() + 1) == month;\n\t\t\t};\n\t\t},\n\t\tafter(date): Function {\n\t\t\tdate = convertToDate(date);\n\t\t\treturn (testDate: Date): boolean => {\n\t\t\t\treturn testDate > date;\n\t\t\t};\n\t\t},\n\t\tbefore(date): Function {\n\t\t\tdate = convertToDate(date);\n\t\t\treturn (testDate: Date): boolean => {\n\t\t\t\treturn testDate < date;\n\t\t\t};\n\t\t},\n\t\tdateSet(dateSet: DateSet): Function {\n\t\t\treturn (testDate: Date): boolean => {\n\t\t\t\treturn dateSet.test(testDate) == true;\n\t\t\t};\n\t\t}\n\t};\n\n\tclearCache() {\n\n\t}\n\n\taddRule(type:string, rule:Function, priority:number = 0): void {\n\t\tif (!this.rules[priority]) this.rules[priority] = [];\n\t\tthis.rules[priority].push([type, rule]);\n\t\tthis.clearCache();\n\t}\n\n\tstatic testRule(type: string, rule: Function, date: Date): boolean|number {\n\t\tvar result = rule(date);\n\t\tif (type == 'include') {\n\t\t\tif (result) return true;\n\t\t\telse return 0;\n\t\t}\n\t\telse if (type == 'exclude') {\n\t\t\tif (result) return false;\n\t\t\telse return 1;\n\t\t}\n\t}\n\n\tresolveRules():any[] {\n\t\tvar priorities = _.map(_.keys(this.rules), (key) => {return parseInt(key)}).sort();//.reverse();\n\t\tvar rules = [];\n\t\tfor (var priority of priorities) {\n\t\t\trules = rules.concat(this.rules[priority]);\n\t\t}\n\t\treturn rules;\n\t}\n\n\ttest(date: Date|string): boolean|number {\n\t\tvar currentResult;\n\n\t\tvar definiteDate = convertToDate(date);\n\n\t\tvar rules = this.resolveRules();\n\t\tfor (var i = rules.length - 1; i >= 0; --i) {\n\t\t\tcurrentResult = DateSet.testRule(rules[i][0], rules[i][1], definiteDate);\n\t\t\tif (typeof currentResult == 'boolean') return currentResult;\n\t\t}\n\t\treturn currentResult;\n\t}\n\n\tearliestDate(maxDaysInFuture: number = 30): Date {\n\t\tvar date = today();\n\t\tvar daysAhead = 0;\n\t\twhile (!this.test(date) && daysAhead < maxDaysInFuture) {\n\t\t\tdate = addDays(date, 1);\n\t\t\t++daysAhead;\n\t\t}\n\t\tif (this.test(date)) {\n\t\t\treturn date;\n\t\t}\n\t\telse {\n\t\t\treturn null;\n\t\t}\n\t}\n}\n\n","import * as _ from 'lodash';\nimport * as moment from 'moment';\n\nexport function today() {\n\tvar now = new Date();\n\treturn createDay(now.getFullYear(), now.getMonth(), now.getDate());\n}\n\nexport function createDay(year, month, day) {\n  return new Date(year, month, day, 0, 0, 0);\n}\nexport function addDays(date, days) {\n  return createDay(date.getFullYear(), date.getMonth(), date.getDate() + days);\n}\nexport function firstDayOfMonth(month) {\n  return createDay(month.getFullYear(), month.getMonth(), 1);\n}\nexport function calendarDaysForMonth(month) {\n  var days = [];\n  var firstDay = firstDayOfMonth(month);\n  for (var i = 0; i < 7 - (7 - firstDay.getDay()); ++ i) {\n    days.unshift(addDays(firstDay, -(i + 1)));\n  }\n  var day = firstDay;\n  while (day.getMonth() == month.getMonth() || day.getMonth() > month.getMonth() && days.length % 7) {\n    days.push(day);\n    day = addDays(day, 1);\n  }\n  return days;\n}\n\nexport function convertToDate(date: Date|string): Date {\n  if (typeof date == 'string') {\n    return (<any>moment(date))._d;\n  }\n  else {\n    return <Date>date;\n  }\n}\n\nexport function formatDate(date) {\n  return date.getFullYear() + '-' + _.padStart(date.getMonth() + 1, 2, '0') + '-' + _.padStart(date.getDate(), 2, '0');\n}\n\n\nexport function weeksForMonth(month: Date):Array<Array<Date>> {\n  var days = calendarDaysForMonth(month);\n  var weeks = [];\n  for (var i = 0; i < days.length/7; ++i) {\n    weeks.push(days.slice(i*7, i*7 + 7));\n  }\n  return weeks;\n}\n\n\n","import * as _ from 'lodash';\nimport { today, addDays } from './date';\n\nfunction round(amount) {\n  return parseFloat(amount.toFixed(2));  \n}\n\nexport function orderCheckAgainstTrigger(order, trigger, api) {\n  var hasAllergies, hasMealPlan, hasPortion, hasMeal, hasAddOn;\n  for (let bundle of order.bundles) {\n    if (trigger.matchOrders == 'withAllergies' && bundle.allergies.length) {\n      hasAllergies = true;\n    }\n    if (trigger.productType == 'meal') {\n      for (let mealSelection of bundle.mealSelections) {\n        if ((trigger.meal && api.compareObjectId(trigger.meal, mealSelection.meal._id) || !trigger.meal) && mealSelection.quantity >= trigger.quantity) {\n          hasMeal = true;\n          break;\n        }\n      }\n      if (trigger.mealPlan && api.compareObjectId(trigger.mealPlan, bundle.mealPlan._id)) {\n        hasMealPlan = true;\n      }\n      if (trigger.portion && api.compareObjectId(trigger.portion, bundle.portion._id)) {\n        hasPortion = true;\n      }\n    }\n  }\n\n  if (trigger.productType == 'addOn') {\n    for (let addOnSelection of order.addOnSelections) {\n      if ((trigger.addOn && api.compareObjectId(trigger.addOn, addOnSelection.addOn._id) || !trigger.addOn) && addOnSelection.quantity >= trigger.quantity) {\n        hasAddOn = true;\n      }\n    }\n  }\n\n  if (trigger.matchOrders == 'withAllergies' && !hasAllergies) {\n    return false;\n  }\n  if (trigger.productType == 'meal') {\n    if (!hasMeal) {\n      return false;\n    }\n    if (trigger.mealPlan && !hasMealPlan) {\n       return false;\n    }\n    if (trigger.portion && !hasPortion) {\n       return false;\n    }\n  }\n  else if (trigger.productType == 'addOn') {\n    if (!hasAddOn) {\n      return false;\n    }\n  }\n  return true;\n}\nexport function orderQueryTriggers(order, triggers, api) {\n  var triggered = [];\n  for (let trigger of triggers) {\n    if (orderCheckAgainstTrigger(order, trigger, api)) {\n      triggered.push(trigger);\n    }\n  }\n  return triggered;\n}\n\n\nexport function orderCheckAgainstTriggers(order, triggers, api) {\n  var triggered = orderQueryTriggers(order, triggers, api);\n  if (triggered.length) {\n    triggered.sort((a, b) => b.delay - a.delay);\n    return triggered[0];\n  }\n  else {\n    return false;\n  }\n}\n\nexport function orderFlagged(order, api) {\n  for (let bundle of order.bundles) {\n    if (api.compareObjectId(bundle.mealPlan._id, api.findOne('mealPlans', {name:'Heavy Duty'})._id) && api.compareObjectId(bundle.portion._id, api.findOne('portions', {name:'For Her'})._id)) {\n      return true;\n    }\n    for (let mealSelection of bundle.mealSelections) {\n      if (mealSelection.quantity >= 7) {\n        return true;\n      }\n      if (api.mealStock(mealSelection.meal) < mealSelection.quantity) {\n        return true;\n      }\n      if (_.intersection(bundle.allergies.map(allergy => allergy._id),\n         mealSelection.meal.allergens.map(allergen => allergen._id)).length) {\n        return true;\n      }\n    }\n  }\n  var triggers = orderQueryTriggers(order, api.anomalyTriggers, api);\n  for (var trigger of triggers) {\n    if (trigger.flagOrder) {\n      return true;\n    }\n  }\n  return false;\n}\n\nexport function orderFulfillmentDays(order, api) {\n  var trigger = orderCheckAgainstTriggers(order, api.anomalyTriggers, api);\n  if (trigger) {\n    return trigger.delay;\n  }\n  else if (orderFlagged(order, api)) {\n    return 3;\n  }\n  else {\n    return api.fulfillmentSettings.minDays;\n  }\n}\n\nexport function excludeAvailabilityDate(opts) {\n  return (date) => {\n    if (opts.excludedFulfillmentDates.test(date)) {\n      return true;\n    }\n\n    var fulfillmentDays = opts.fulfillmentDays();\n\n\n    var day = today();\n    if (new Date().getHours() >= opts.api.fulfillmentSettings.cutoffTime) {\n      day = addDays(day, 1);\n    }\n\n    while (fulfillmentDays) {\n      day = addDays(day, 1);\n      if (!opts.excludedFulfillmentDates.test(day)) {\n        --fulfillmentDays;\n      }\n    }\n\n    return date < day;\n  };\n}\n\nexport function orderTotalMeals(order: any) {\n  return _.reduce(order.bundles, (totalMeals: any, bundle: any) => {\n    return totalMeals + _.reduce(bundle.mealSelections, (t, mealSelection: any) => {\n      return t + mealSelection.quantity;\n    }, 0);\n  }, 0);\n}\n\n\nexport function bundlePrice(bundle: any): number {\n  if (bundle.promotion) {\n    var promotionPrice;\n    if (bundle.promotion.type == 'discount') {\n      promotionPrice = bundle.type.price * (100 - bundle.promotion.discount)/100;\n    }\n    else if (bundle.promotion.type == 'override') {\n      promotionPrice = bundle.promotion.overridePrice;\n    }\n    return round(promotionPrice);\n  }\n  else {\n    return bundle.type.price;\n  } \n}\n\nexport function allergyTotal(allergy: any, bundle: any): number {\n  if (allergy.action == 'remove') {\n    for (var mealSelection of bundle.mealSelections) {\n      if (_.some(mealSelection.meal.allergens, {_id:allergy._id})) {\n        return allergy.surcharge;\n      }\n    }\n  }\n  else if (allergy.action == 'substitute') {\n    var total = 0;\n    for (var mealSelection of bundle.mealSelections) {\n      if (_.some(mealSelection.meal.allergens, { _id: allergy._id })) {\n        total += allergy.surcharge*mealSelection.quantity;\n      }\n    }\n    return total;\n  }\n  return 0;\n}\n\nexport function bundlePremiumTotal(bundle: any) {\n  var total = 0;\n  var totalPremiumMeals = 0;\n  for (var mealSelection of bundle.mealSelections) {\n    if (mealSelection.meal.grade == 'premium') {\n      for (var i = 0; i < mealSelection.quantity; ++ i) {\n        totalPremiumMeals++;\n        if (totalPremiumMeals > (bundle.promotion && typeof bundle.promotion.premiumAllowance == 'number' ? bundle.promotion.premiumAllowance : bundle.type.premiumMeals)) {\n          total += mealSelection.meal.price;\n        }        \n      }\n    }\n  }\n  return round(total);\n}\n\nexport function bundleTotal(bundle: any): number {\n  var total = bundle.price;\n  total += bundlePremiumTotal(bundle);\n  // var totalPremiumMeals = 0;\n  // for (var mealSelection of bundle.mealSelections) {\n  //   if (mealSelection.meal.grade == 'premium') {\n  //     for (var i = 0; i < mealSelection.quantity; ++ i) {\n  //       totalPremiumMeals++;\n  //       if (totalPremiumMeals > (bundle.promotion && typeof bundle.promotion.premiumAllowance == 'number' ? bundle.promotion.premiumAllowance : bundle.type.premiumMeals)) {\n  //         total += mealSelection.meal.price;\n  //       }        \n  //     }\n  //   }\n  // }\n  for (var allergy of bundle.allergies) {\n    total += allergyTotal(allergy, bundle);\n  }\n  return round(total);\n}\n\nexport function orderSubtotal(order: any): number {\n  var subtotal = 0;\n  var allergyRemovals = {};\n  for (var bundle of order.bundles) {\n    subtotal += bundle.total;\n  }\n  for (var addOnSelection of order.addOnSelections) {\n    subtotal += addOnSelection.addOn.price*addOnSelection.quantity;\n  }\n  return round(subtotal);\n}\n\nexport function orderTotal(order: any): number {\n  var total = order.subtotal + order.deliveryFee;\n  return round(total);\n}\n\nexport function orderLocationSurcharge(order: any, api: any): number {\n  for (var locationSurcharge of api.locationSurcharges) {\n    if (_.startsWith(order.deliveryOptions.postalCode, locationSurcharge.postalPrefix)) {\n      return locationSurcharge.surcharge;\n    }\n  }\n  return 0;\n}\n\nexport function orderDeliveryFee(order: any, api: any): number {\n  if (order.deliveryOptions.selfCollection) {\n    return 0;\n  }\n  var deliveryFee;\n  for (let bundle of order.bundles) {\n    if (!bundle.type.deliveryFee || (bundle.promotion && !bundle.promotion.deliveryFee)) {\n      deliveryFee = 0;\n      break;\n    }\n  }\n  if (typeof deliveryFee == 'undefined') {\n    if (api.totalMeals(order) >= api.fulfillmentSettings.freeDeliveryThreshold) {\n      deliveryFee = 0;\n    }\n    else {\n      deliveryFee = api.fulfillmentSettings.deliveryFee;\n    }\n  }\n\n  deliveryFee += 'locationSurcharge' in order ? order.locationSurcharge : orderLocationSurcharge(order, api);\n\n  // for (var locationSurcharge of api.locationSurcharges) {\n  //   if (_.startsWith(order.deliveryOptions.postalCode, locationSurcharge.postalPrefix)) {\n  //     deliveryFee += locationSurcharge.surcharge;\n  //     break;\n  //   }\n  // }\n\n  return deliveryFee;\n}","import { Mongo } from 'meteor/mongo';\nexport const AddOns = new Mongo.Collection('addOns', {idGeneration: 'MONGO'});\n","import { Mongo } from 'meteor/mongo';\nexport const AnomalyTriggers = new Mongo.Collection('anomalyTriggers', {idGeneration: 'MONGO'});\n","export const Blocks = new Mongo.Collection('blocks', {idGeneration: 'MONGO'});\nif (Meteor.isServer) {\n  Meteor.publish('blocks', function() {\n  \treturn Blocks.find();\n  });\n}","export const BundleTypes = new Mongo.Collection('bundleTypes', {idGeneration: 'MONGO'});\nif (Meteor.isServer) {\n  Meteor.publish('bundleTypes', function() {\n  \treturn BundleTypes.find();\n  });\n}","export const FulfillmentSettings = new Mongo.Collection('fulfillmentSettings', {idGeneration: 'MONGO'});\n","import { Mongo } from 'meteor/mongo';\nimport { Meteor } from 'meteor/meteor';\nexport const Ingredients = new Mongo.Collection('ingredients', {idGeneration: 'MONGO'});\nif (Meteor.isServer) {\n  Meteor.publish('ingredients', function() {\n  \treturn Ingredients.find();\n  });\n}","import { Mongo } from 'meteor/mongo';\nexport const LocationSurcharges = new Mongo.Collection('locationSurcharges', {idGeneration: 'MONGO'});\n","export const MealPlans = new Mongo.Collection('mealPlans', {idGeneration: 'MONGO'});\nif (Meteor.isServer) {\n  Meteor.publish('mealPlans', function() {\n  \treturn MealPlans.find();\n  });\n}","export const Meals = new Mongo.Collection('meals', {idGeneration: 'MONGO'});\nif (Meteor.isServer) {\n  Meteor.publish('meals', function() {\n  \treturn Meals.find();\n  });\n}","import { Mongo } from 'meteor/mongo';\n \nexport const Orders = new Mongo.Collection('orders', {idGeneration: 'MONGO'});\n\nif (Meteor.isServer) {\n  Meteor.publish('orders', function() {\n  \treturn Orders.find({userId:this.userId});\n  });\n}\n\n// Tasks.allow({\n// \tremove(userId, doc) {\n// \t\tif (doc.private && doc.owner != userId) return false;\n// \t\treturn true;\n// \t},\n// \tinsert(userId) {\n// \t\treturn userId;\n// \t},\n// \tupdate(userId, doc) {\n// \t\treturn true;\n// \t},\n// \tfetch: ['owner', 'private']\n// });","import { Mongo } from 'meteor/mongo';\nimport { Meteor } from 'meteor/meteor';\nexport const Portions = new Mongo.Collection('portions', {idGeneration: 'MONGO'});\nif (Meteor.isServer) {\n  Meteor.publish('portions', function() {\n  \treturn Portions.find();\n  });\n}","export const Promotions = new Mongo.Collection('promotions', {idGeneration: 'MONGO'});\nif (Meteor.isServer) {\n  Meteor.publish('promotions', function() {\n  \treturn Pormotions.find();\n  });\n}","export const Surveys = new Mongo.Collection('surveys', {idGeneration: 'MONGO'});\nif (Meteor.isServer) {\n  Meteor.publish('surveys', function() {\n  \treturn Surveys.find();\n  });\n}\n","export const TimeSlots = new Mongo.Collection('timeSlots', {idGeneration: 'MONGO'});\nif (Meteor.isServer) {\n  Meteor.publish('timeSlots', function() {\n  \treturn TimeSlots.find();\n  });\n}","import { Meteor } from 'meteor/meteor';\nimport { Mongo } from 'meteor/mongo';\nimport { Orders } from '../api/orders';\nimport { Meals } from '../api/meals';\nimport { AddOns } from '../api/addOns';\nimport { BundleTypes } from '../api/bundleTypes';\nimport { MealPlans } from '../api/mealPlans';\nimport { AnomalyTriggers } from '../api/anomalyTriggers';\nimport { TimeSlots } from '../api/timeSlots';\nimport { Promotions } from '../api/promotions';\nimport { FulfillmentSettings } from '../api/fulfillmentSettings';\nimport { LocationSurcharges } from '../api/locationSurcharges';\nimport { MealStock } from '../api/mealStock';\nimport { Ingredients } from '../api/ingredients';\nimport { Portions } from '../api/portions';\nimport { Blocks } from '../api/blocks';\nimport { convertToDate, calendarDaysForMonth, formatDate, createDay } from '../common/scripts/date.ts';\nimport { DateSet } from '../common/scripts/DateSet.ts';\nimport * as _ from 'lodash';\nimport { excludeAvailabilityDate, orderFulfillmentDays, bundleTotal, orderSubtotal, orderDeliveryFee, orderTotal, bundlePrice, orderTotalMeals, orderFlagged, orderLocationSurcharge } from '../common/scripts/order.ts';\n\nimport { HTTP } from 'meteor/http'\n\nfunction getToday() {\n\tvar now = new Date();\n\treturn createDay(now.getFullYear(), now.getMonth(), now.getDate());\n}\n\n\ninterface ObjectID {\n\t_str: string;\n}\n\ninterface FRUser {\n\trole: string;\n\tusername: string;\n\tprofile: {\n\t\tdebug: boolean;\n\t\tfirstName: string;\n\t\tsurname: string;\n\t\tphoneNumber: string;\n\t\tdeliveryAddresses: any[];\n\t};\n\temails: {address:string; verified: boolean}[];\n}\n\ninterface Meal {\n\t_id: ObjectID;\n};\n\ninterface MealStock {\n\tstock: number;\n};\n\ninterface TimeSlot {\n\t_id: ObjectID;\n\tstart: string;\n\tend: string;\n}\n\ninterface Portion {\n\t_id: ObjectID;\n}\ninterface MealPlan {\n\t_id: ObjectID;\n}\ninterface BundleType {\n\t_id: ObjectID;\n}\n\ninterface Promotion {\n\tstart: string;\n\tend: string;\n\tfulfillmentStart: string;\n\tfulfillmentEnd: string;\n\tmealPlan: ObjectID;\n\tportion: ObjectID;\n\tbundleType: ObjectID;\n\tdeliveryFee: boolean;\n\tusageLimit: number;\n\tpremiumCap: number;\n\tpremiumAllowance: number;\n\t_id: ObjectID;\n}\n\nexport interface Ingredient {\n\n}\n\nnamespace Order {\n\texport interface Bundle {\n\t\tportion?: Portion;\n\t\tmealPlan?: MealPlan;\n\t\ttype?: BundleType;\n\t\tallergies?: Ingredient[];\n\t\tmealSelections?: MealSelection[];\n\t\tpromotion?: Promotion;\n\t\tprice?: number;\n\t\ttotal?: number;\n\t\tdeliveryFee?: boolean;\n\t}\n\n\texport interface MealSelection {\n\n\t}\n\n\texport interface AddOnSelection {\n\n\t}\n}\n\ninterface Order {\n\tstatus?: string;\n\tflagged?: boolean;\n\temailError?: any;\n\tdebug?: boolean;\n\ttransaction?: any;\n\tstate?: string;\n\tcreatedAt?: Date;\n\tuserId?: string;\n\taddOnSelections?: Order.AddOnSelection[];\n\tbundles?: Order.Bundle[];\n\tdeliveryOptions?: {\n\t\tdate: string;\n\t\tfirstName: string;\n\t\ttime: TimeSlot;\n\t\tsurname: string;\n\t\tselfCollection: boolean;\n\t};\n\tsubtotal?: number;\n\ttotal?: number;\n\tnumber?: number;\n\tlocationSurcharge?: number;\n\tdeliveryFee?: number;\n}\n\nnamespace OrderData {\n\texport interface MealSelection {\n\t\tmealId: string;\n\t\tquantity: number;\n\t}\n\n\texport interface AddOnSelection {\n\t\taddOnId: string;\n\t\tquantity: number;\n\t\tvariant: string;\n\t}\n\n\texport interface Bundle {\n\t\tpromotion: string;\n\t\tmealPlan: string;\n\t\tportion: string;\n\t\ttype: string;\n\t\tallergies: string[];\n\t\tmealSelections: MealSelection[];\n\t}\n}\n\ninterface OrderData {\n\tbundles: OrderData.Bundle[];\n\taddOnSelections: OrderData.AddOnSelection[];\n\tdeliveryOptions: any;\n\tuserId: string;\n\tpaymentNonce: any;\n}\n\n\nexport const Errors = new Mongo.Collection('errors', {idGeneration: 'MONGO'});\n\ndeclare var tx:any;\n\nif (!('toJSON' in Error.prototype))\nObject.defineProperty(Error.prototype, 'toJSON', {\n    value: function () {\n        var alt = {};\n\n        Object.getOwnPropertyNames(this).forEach(function (key) {\n            alt[key] = this[key];\n        }, this);\n\n        return alt;\n    },\n    configurable: true,\n    writable: true\n});\n\nfunction nextOrderNumber() {\n\tvar order = Orders.findOne({debug:null}, {sort:{number:-1}});\n\tif (order) {\n\t\treturn order.number + 1;\n\t}\n\telse {\n\t\treturn 8050;\n\t}\n}\n\nfunction amPm(time, appendSuffix=true) {\n  var date = new Date(Date.parse('Jan 1 ' + time));\n  var hours = date.getHours();\n  var suffix = hours >= 12 ? \"pm\":\"am\";\n  hours = ((hours + 11) % 12 + 1); \n\n  return hours + (appendSuffix ? '' + suffix : '');\n}\n\n\nvar _mealStock = null;\nvar _mealStockDate = null;\nfunction getMealStock() {\n\tvar today = getToday();\n\tif (_mealStock && _mealStockDate.valueOf() == today.valueOf()) {\n\t\treturn _mealStock;\n\t}\n\t_mealStock = HTTP.get(Meteor.settings.public.adminUrl + 'api/stock').data;\n\t_mealStockDate = getToday();\n\treturn _mealStock;\n}\n\nclass OrderApi {\n\t_mealStock = null;\n\tfulfillmentSettings: any;\n\tanomalyTriggers: any;\n\tfindOne(collectionName, query) {\n\t\tvar collection;\n\t\tswitch (collectionName) {\n\t\t\tcase 'mealPlans': collection = MealPlans; break;\n\t\t\tcase 'portions': collection = Portions; break;\n\t\t}\n\t\treturn collection.findOne(query);\n\t}\n\tcompareObjectId(a: ObjectID, b: ObjectID) {\n\t\treturn a._str == b._str;\n\t}\n\tmealStock(meal: Meal) {\n\t\tvar getMealStock = () => {\n\t\t\tif (!this._mealStock) {\n\t\t\t\tthis._mealStock = HTTP.get(Meteor.settings.public.adminUrl + 'api/stock').data;\n\t\t\t}\n\t\t\treturn this._mealStock;\n\t\t}\n\n\t\treturn getMealStock()[meal._id._str];\n\t}\n\tconstructor() {\n\t\tthis.fulfillmentSettings = FulfillmentSettings.findOne();\n\t\tthis.anomalyTriggers = AnomalyTriggers.find().fetch();\n\t}\n}\n\nexport function timeSlotsForMonth(month) {\n\treturn timeSlotsForDates(calendarDaysForMonth(month));\n}\n\nexport function timeSlotsForDates(dates) {\n\tlet minDate = formatDate(dates[0]);\n\tlet maxDate = formatDate(dates[dates.length - 1]);\n\tlet orders:Order[] = <Order[]>Orders.find({'deliveryOptions.date':{$gte:minDate, $lte:maxDate}, state: 'completed'}).fetch();\n\tlet ordersByDate = {};\n\tfor (let order of orders) {\n\t\tif (!ordersByDate[order.deliveryOptions.date]) {\n\t\t\tordersByDate[order.deliveryOptions.date] = [];\n\t\t}\n\t\tordersByDate[order.deliveryOptions.date].push(order);\n\t}\n\n\tlet timeSlotsById = _.reduce(TimeSlots.find().fetch(), (timeSlotsById, timeSlot: TimeSlot) => {\n\t\ttimeSlotsById[timeSlot._id._str] = timeSlot;\n\t\treturn timeSlotsById;\n\t}, {});\n\n\tlet availableTimeSlotsByDate = {};\n\tfor (let date of dates) {\n\t\tlet timeSlotsForDate = [];\n\t\tfor (let timeSlotId in timeSlotsById) {\n\t\t\tif (timeSlotsById[timeSlotId].days[date.getDay()] && timeSlotsById[timeSlotId].capacity) {\n\t\t\t\ttimeSlotsForDate.push(timeSlotId);\n\t\t\t}\n\t\t}\n\n\t\tdate = formatDate(date);\n\t\tlet ordersByTimeSlot = {};\n\t\tif (ordersByDate[date]) {\n\t\t\tlet ordersByTimeSlot = {};\n\t\t\tfor (let order of ordersByDate[date]) {\n\t\t\t\tif (!ordersByTimeSlot[order.deliveryOptions.time._id._str]) {\n\t\t\t\t\tordersByTimeSlot[order.deliveryOptions.time._id._str] = [];\n\t\t\t\t}\n\t\t\t\tordersByTimeSlot[order.deliveryOptions.time._id._str].push(order);\n\t\t\t}\n\t\t\tavailableTimeSlotsByDate[date] = [];\n\t\t\tfor (let timeSlotId of timeSlotsForDate) {\n\t\t\t\tlet timeSlot = timeSlotsById[timeSlotId];\n\t\t\t\tif (!ordersByTimeSlot[timeSlotId] || ordersByTimeSlot[timeSlotId].length < timeSlot.capacity) {\n\t\t\t\t\tavailableTimeSlotsByDate[date].push(timeSlotId);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tavailableTimeSlotsByDate[date] = timeSlotsForDate;\n\t\t}\n\t}\n\treturn availableTimeSlotsByDate;\n}\n\ninterface CreateOrderOptions {\n\tcharge?: boolean;\n\tgateway?: any;\n\tsendEmails?: boolean;\n\ttransactions?: boolean;\n}\n\nexport function createOrder(orderData: OrderData, userId: string, opts: CreateOrderOptions = {}): boolean|any {\n\ttry {\n\t\tlet user: FRUser = <FRUser>Meteor.users.findOne({_id:userId});\n\n\t\tif (orderData.userId) {\n\t\t\tif (user.role == 'admin') {\n\t\t\t\tuserId = orderData.userId;\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tlet index = 0;\n\t\tfor (let bundle of orderData.bundles) {\n\t\t\tif (bundle.promotion) {\n\t\t\t\tlet result = validatePromotion(userId, orderData, Promotions.findOne({_id:new Mongo.ObjectID(bundle.promotion)}));\n\t\t\t\tif (_.isArray(result) && result.indexOf(index) == -1 || !_.isArray(result)) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\terror: 'invalidPromotion',\n\t\t\t\t\t\tpromotionStatus: result\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t\t++ index;\n\t\t}\n\n\t\tlet order = resolveOrder(orderData, userId);\n\n\t\tlet availabilityDates = availablilityDatesForOrder(order);\n\t\tlet timeSlots = timeSlotsForDates([convertToDate(order.deliveryOptions.date)])[order.deliveryOptions.date];\n\n\t\tif (availabilityDates.test(convertToDate(order.deliveryOptions.date)) && timeSlots && timeSlots.indexOf(order.deliveryOptions.time._id._str) != -1) {\n\t\t\torder.state = 'charging';\n\t\t\torder.createdAt = new Date();\n\t\t\tlet orderId = Orders.insert(order);\n\n\t\t\tlet response;\n\t\t\tif (order.total > 0 && opts.charge && !user.profile.debug) {\n\t\t\t\tresponse = Meteor.wrapAsync(opts.gateway.transaction.sale, opts.gateway.transaction)({\n\t\t\t\t\tamount: order.total,\n\t\t\t\t\tpaymentMethodNonce: orderData.paymentNonce,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tsubmitForSettlement: true\n\t\t\t\t\t},\n\t\t\t\t\tcustomer: {\n\t\t\t\t\t\tfirstName: order.deliveryOptions.firstName,\n\t\t\t\t\t\tlastName: order.deliveryOptions.surname,\n\t\t\t\t\t\temail: (user.username.match(/@/g) || []).length == 1 ? user.username : null\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (!opts.charge || order.total === 0 || user.profile.debug || (opts.charge && response.success)) {\n\t\t\t\tif (response) order.transaction = response.transaction;\n\t\t\t\torder.state = 'processing';\n\t\t\t\tOrders.update({_id:orderId}, order);\n\n\t\t\t\tlet userUpdates = {};\n\t\t\t\tif (!user.profile.firstName) {\n\t\t\t\t\tuser.profile.firstName = userUpdates['profile.firstName'] = orderData.deliveryOptions.firstName;\n\t\t\t\t}\n\t\t\t\tif (!user.profile.surname) {\n\t\t\t\t\tuserUpdates['profile.surname'] = orderData.deliveryOptions.surname;\n\t\t\t\t}\n\t\t\t\tif (!user.profile.phoneNumber) {\n\t\t\t\t\tuserUpdates['profile.phoneNumber'] = orderData.deliveryOptions.contactNumber;\n\t\t\t\t}\n\t\t\t\tif (!user.profile.deliveryAddresses.length) {\n\t\t\t\t\tuserUpdates['profile.deliveryAddresses'] = [{address:orderData.deliveryOptions.address, postalCode:orderData.deliveryOptions.postalCode}];\n\t\t\t\t\tuserUpdates['profile.selectedDeliveryAddress'] = 0;\n\t\t\t\t}\n\t\t\t\tif (!_.isEmpty(userUpdates)) {\n\t\t\t\t\tMeteor.users.update({_id:userId}, {$set:userUpdates});\n\t\t\t\t}\n\n\t\t\t\tif (user.profile.debug) {\n\t\t\t\t\torder.debug = true;\n\t\t\t\t}\n\n\t\t\t\tif (opts.sendEmails) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tif (order.deliveryOptions.selfCollection) {\n\t\t\t\t\t\t\tEmail.send({\n\t\t\t\t\t\t\t\tto: user.emails[0].address,\n\t\t\t\t\t\t\t\tfrom: Accounts.emailTemplates.from,\n\t\t\t\t\t\t\t\tsubject: 'Self-Collection of your Fitness Ration meals',\n\t\t\t\t\t\t\t\thtml: `\n\t\t\t\t\t\t\t\t\t<p>Dear ${user.profile.firstName},</p>\n\t\t\t\t\t\t\t\t\t<p>Your order #${order.number} is confirmed for self-collection on ${order.deliveryOptions.date} at ${amPm(order.deliveryOptions.time.start)}-${amPm(order.deliveryOptions.time.end)}.</p>\n\t\t\t\t\t\t\t\t\t<p>To view your current order summary and e-receipt, <a href=\"http://www.fitnessration.com.sg/#login\">log in to your account here.</a></p>\n\t\t\t\t\t\t\t\t\t<p>Have a question?<br>\n\t\t\t\t\t\t\t\t\tRefer to our <a href=\"http://www.fitnessration.com.sg/faq.php\">FAQ</a> or drop us an email at enquiries@fitnessration.com.sg</p>\n\t\t\t\t\t\t\t\t\t<p>Remember to like us on <a href=\"http://www.facebook.com/fitnessration\">Facebook</a> for the latest menu, promotions and events.</p>\n\t\t\t\t\t\t\t\t\t<p>Enjoy your meals!<br>\n\t\t\t\t\t\t\t\t\tTeam Fitness Ration</p>`\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tEmail.send({\n\t\t\t\t\t\t\t\tto: user.emails[0].address,\n\t\t\t\t\t\t\t\tfrom: Accounts.emailTemplates.from,\n\t\t\t\t\t\t\t\tsubject: 'Confirmed delivery of your Fitness Ration meals',\n\t\t\t\t\t\t\t\thtml: `\n\t\t\t\t\t\t\t\t\t<p>Dear ${user.profile.firstName},</p>\n\t\t\t\t\t\t\t\t\t<p>Your order #${order.number} is confirmed for delivery on ${order.deliveryOptions.date} at ${amPm(order.deliveryOptions.time.start)}-${amPm(order.deliveryOptions.time.end)}. Be sure to have someone to receive your bundles on delivery day!</p>\n\t\t\t\t\t\t\t\t\t<p>To view your current order summary and e-receipt, <a href=\"http://www.fitnessration.com.sg/#login\">log in to your account here.</a></p>\n\t\t\t\t\t\t\t\t\t<p>Have a question?<br>\n\t\t\t\t\t\t\t\t\tRefer to our <a href=\"http://www.fitnessration.com.sg/faq.php\">FAQ</a> or drop us an email at enquiries@fitnessration.com.sg</p>\n\t\t\t\t\t\t\t\t\t<p>Remember to like us on <a href=\"http://www.facebook.com/fitnessration\">Facebook</a> for the latest menu, promotions and events.</p>\n\t\t\t\t\t\t\t\t\t<p>Enjoy your meals!<br>\n\t\t\t\t\t\t\t\t\tTeam Fitness Ration</p>`\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\t\n\t\t\t\t\t}\n\t\t\t\t\tcatch (e) {\n\t\t\t\t\t\torder.emailError = JSON.parse(JSON.stringify(e));\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\torder.status = 'pending';\n\t\t\t\torder.flagged = orderFlagged(order, new OrderApi);\n\t\t\t\torder.state = 'completed';\n\t\t\t\tif (opts.transactions) tx.start('create order');\n\t\t\t\tOrders.update({_id:orderId}, order);\n\t\t\t\tif (opts.transactions) tx.commit();\n\t\t\t\t\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\torderId: orderId._str\n\t\t\t\t};\n\t\t\t}\n\t\t\telse {\n\t\t\t\torder.state = 'failed';\n\t\t\t\torder.error = 'payment';\n\t\t\t\torder.paymentResponse = response;\n\t\t\t\tOrders.update({_id:orderId}, order);\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\terror: 'payment',\n\t\t\t\t\tresponse: response\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tlet cursor = Meals.find()\n\t\t\tlet stock = {};\n\t\t\tcursor.forEach(function(meal) {\n\t\t\t\tstock[meal._id._str] = meal.stock;\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'deliveryDate',\n\t\t\t\tstock: stock,\n\t\t\t};\n\t\t}\n\t}\n\tcatch (e) {\n\t\tlet error = JSON.parse(JSON.stringify(e));\n\t\terror.createdAt = new Date();\n\t\terror.orderData = orderData;\n\t\tErrors.insert(error);\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: 'inernalError',\n\t\t\te:e\n\t\t};\n\t}\n}\n\nexport function availablilityDatesForOrder(order: Order): DateSet {\n\tlet excluded = [\n\t\t['dayOfYear', '10-29'],\n\t\t['dayOfYear', '09-12']\n\t];\n\tlet blocks = Blocks.find().fetch();\n\tfor (let block of blocks) {\n\t\texcluded.push(['range', formatDate(block.start), formatDate(block.end)]);\n\t}\n\tlet excludedDates = new DateSet();\n\tfor (let rule of excluded) {\n\t\texcludedDates.addRule('include', DateSet.rule[rule[0]].apply(DateSet, rule.slice(1)));\n\t}\n\tvar orderApi = new OrderApi;\n\n\tlet availabilityDates = new DateSet();\n\tavailabilityDates.addRule('exclude', excludeAvailabilityDate({\n\t\texcludedFulfillmentDates:excludedDates,\n\t\tfulfillmentDays: () => orderFulfillmentDays(order, orderApi),\n\t\tapi:orderApi\n\t}));\n\n\tfor (let bundle of order.bundles) {\n\t\tif (bundle.promotion && bundle.promotion.fulfillmentStart && bundle.promotion.fulfillmentEnd) {\n\t\t\tavailabilityDates.addRule('exclude', DateSet.rule.invertedRange(bundle.promotion.fulfillmentStart, bundle.promotion.fulfillmentEnd));\n\t\t}\n\t}\n\n\treturn availabilityDates;\n}\n\n\n// TODO: Eliminate nesting\nexport function validatePromotion(userId: string, order: OrderData, promotion: Promotion): any {\n\tif (promotion) {\n\t\tlet now = new Date();\n\t\tlet today = formatDate(now);\n\t\tif (now.getTime() >= Date.parse(promotion.start)) {\n\t\t\tif (now.getTime() < Date.parse(promotion.end)) {\n\t\t\t\tif (!order.deliveryOptions.date || !(promotion.fulfillmentStart && promotion.fulfillmentEnd) || order.deliveryOptions.date >= promotion.fulfillmentStart && order.deliveryOptions.date <= promotion.fulfillmentEnd) {\n\t\t\t\t\tlet used = false;\n\t\t\t\t\tif (promotion.usageLimit) {\n\t\t\t\t\t\tlet count = Orders.find({userId:userId, bundles:{$elemMatch:{'promotion._id':promotion._id}}}).count();\n\t\t\t\t\t\tused = count >= promotion.usageLimit;\n\t\t\t\t\t}\n\t\t\t\t\tif (!used) {\n\t\t\t\t\t\tif (promotion.premiumCap !== null) {\n\t\t\t\t\t\t\tlet premiumCount = 0;\n\t\t\t\t\t\t\tfor (let bundle of order.bundles) {\n\t\t\t\t\t\t\t\tfor (let mealSelection of bundle.mealSelections) {\n\t\t\t\t\t\t\t\t\tif (Meals.findOne(new Mongo.ObjectID(mealSelection.mealId)).grade == 'premium') {\n\t\t\t\t\t\t\t\t\t\tpremiumCount += mealSelection.quantity;\n\t\t\t\t\t\t\t\t\t\tif (premiumCount > promotion.premiumCap) {\n\t\t\t\t\t\t\t\t\t\t\treturn {error:'surpassedPremiumCap', premiumCap: promotion.premiumCap};\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet bundles = [];\n\t\t\t\t\t\tlet index = 0;\n\t\t\t\t\t\tfor (let bundle of order.bundles) {\n\t\t\t\t\t\t\tif (promotion.mealPlan && bundle.mealPlan != promotion.mealPlan._str) continue;\n\t\t\t\t\t\t\tif (promotion.portion && bundle.portion != promotion.portion._str) continue;\n\t\t\t\t\t\t\tif (promotion.bundleType && bundle.type != promotion.bundleType._str) continue;\n\t\t\t\t\t\t\tbundles.push(index);\n\t\t\t\t\t\t\t++ index;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (bundles.length) {\n\t\t\t\t\t\t\treturn bundles;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\treturn 'notCompatible';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\treturn 'alreadyUsed';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn 'invalidFulfillmentDate';\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn 'promotionEnded';\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\treturn 'promotionNotStarted';\n\t\t}\n\t}\n\telse {\n\t\treturn 'invalidPromoCode';\n\t}\t\n}\n\n\nexport function resolveOrder(orderData: OrderData, userId: string): Order {\n\tvar fulfillmentSettings = FulfillmentSettings.findOne();\n\tvar bundles = [];\n\tfor (var bundleData of orderData.bundles) {\n\t\tvar bundle: Order.Bundle = {\n\t\t\tportion: <Portion>Portions.findOne({_id:new Mongo.ObjectID(bundleData.portion)}),\n\t\t\tmealPlan: <MealPlan>MealPlans.findOne({_id:new Mongo.ObjectID(bundleData.mealPlan)}),\n\t\t\ttype: <BundleType>BundleTypes.findOne({_id:new Mongo.ObjectID(bundleData.type)}),\n\t\t\tallergies: <Ingredient[]>_.map(bundleData.allergies, (allergyId: string) => {return Ingredients.findOne({_id:new Mongo.ObjectID(allergyId)})}),\n\t\t\tmealSelections: <Order.MealSelection[]>_.map(bundleData.mealSelections, (mealSelection: OrderData.MealSelection): Order.MealSelection => {\n\t\t\t\treturn {\n\t\t\t\t\tmeal: Meals.findOne({_id:new Mongo.ObjectID(mealSelection.mealId)}),\n\t\t\t\t\tquantity: mealSelection.quantity\n\t\t\t\t};\n\t\t\t}),\n\t\t\tpromotion: bundleData.promotion ? Promotions.findOne({_id: new Mongo.ObjectID(bundleData.promotion)}) : undefined\n\t\t};\n\t\tbundle.price = bundlePrice(bundle);\n\t\tbundle.total = bundleTotal(bundle);\n\t\tbundles.push(bundle);\n\t}\n\tvar order: Order = {\n\t\tuserId: userId,\n\t\taddOnSelections: _.map(orderData.addOnSelections, (addOnSelection) => {\n\t\t\treturn {\n\t\t\t\taddOn: AddOns.findOne({_id:new Mongo.ObjectID(addOnSelection.addOnId)}),\n\t\t\t\tvariant: addOnSelection.variant,\n\t\t\t\tquantity: addOnSelection.quantity,\n\t\t\t};\n\t\t}),\n\t\tbundles:bundles,\n\t\tdeliveryOptions:orderData.deliveryOptions,\n\t\t// promotion: orderData.promotion ? Promotions.findOne({_id:new Mongo.ObjectID(orderData.promotion)}) : undefined\n\t};\n\tif (orderData.deliveryOptions) {\n\t\tif (orderData.deliveryOptions.time) {\n\t\t\tvar timeSlot = TimeSlots.findOne({_id:new Mongo.ObjectID(orderData.deliveryOptions.time)});\n\t\t\torder.deliveryOptions.time = {_id:timeSlot._id, start:timeSlot.start, end:timeSlot.end};\n\t\t}\n\t\torder.locationSurcharge = orderLocationSurcharge(order, {\n\t\t\tlocationSurcharges: LocationSurcharges.find().fetch()\n\t\t});\n\t\torder.deliveryFee = orderDeliveryFee(order, {\n\t\t\ttotalMeals(order) {\n\t\t\t\treturn orderTotalMeals(order);\n\t\t\t},\n\t\t\tfulfillmentSettings: fulfillmentSettings,\n\t\t\tlocationSurcharges: LocationSurcharges.find().fetch()\n\t\t});\n\t}\n\torder.subtotal = orderSubtotal(order);\n\torder.total = orderTotal(order);\n\torder.number = nextOrderNumber();\n\treturn order;\n}\n","import {Facebook, FacebookApiException} from 'fb';\nimport { Meteor } from 'meteor/meteor';\nimport { Surveys } from '../imports/api/surveys';\nimport { Meals } from '../imports/api/meals';\nimport { Promotions } from '../imports/api/promotions';\nimport * as _ from 'lodash';\nimport { HTTP } from 'meteor/http'\nimport { convertToDate, calendarDaysForMonth, formatDate } from '../imports/common/scripts/date';\nimport { excludeAvailabilityDate, orderFulfillmentDays, bundleTotal, orderSubtotal, orderDeliveryFee, orderTotal, bundlePrice, orderTotalMeals, orderFlagged, orderLocationSurcharge } from '../imports/common/scripts/order';\nimport { validatePromotion, resolveOrder, availablilityDatesForOrder, timeSlotsForMonth, createOrder } from '../imports/server/main';\nimport lockFile from 'lockfile';\n\nAccounts.onCreateUser((options, user) => {\n\tuser.username = user.username.toLowerCase();\n\tif (!user.profile) {\n\t\tuser.profile = {};\n\t}\n\tuser.profile.preferences = {};\n\tuser.profile.deliveryAddresses = [];\n\tif (!user.profile.firstName && options.firstName) {\n\t\tuser.profile.firstName = options.firstName;\n\t}\n\tif (!user.profile.surname && options.surname) {\n\t\tuser.profile.surname = options.surname;\n\t}\n\treturn user;\n});\n\nAccounts.config({\n  loginExpirationInDays: 1000\n});\n\nvar gateway;\nMeteor.startup(function () {\n\tvar braintree = require('braintree');\n\tgateway = braintree.connect({\n\t\tenvironment: Meteor.settings.braintree.environment == 'sandbox' ? braintree.Environment.Sandbox : braintree.Environment.Production,\n\t\tpublicKey: Meteor.settings.braintree.publicKey,\n\t\tprivateKey: Meteor.settings.braintree.privateKey,\n\t\tmerchantId: Meteor.settings.braintree.merchantId\n\t});\n});\n\nAccounts.emailTemplates.from = 'Fitness Ration <no-reply@fitnessration.com.sg>';\nAccounts.emailTemplates.resetPassword.subject = () => {\n\treturn 'Password recovery for your Fitness Ration account';\n};\nAccounts.emailTemplates.resetPassword.html = (user, url) => {\n\treturn `\n\t\t<p>Dear ${user.profile.firstName},</p>\n\t\t<p>You have requested for a password recovery in your Fitness Ration account.</p>\n\t\t<p>To change your password, <a href=\"${url}\">click here</a> to login to your user dashboard.</p>\n\n\t\t<p>If you <b>did not</b> request for a password recovery, please email us immediately at enquiries@fitnessration.com.sg and we will respond within 24 hours.</p>\n\n\t\t<p>Sincerely,<br>\n\t\tTeam Fitness Ration</p>`;\n};\n\nMeteor.publish('user', () => {\n\treturn Meteor.users.find({_id:this.userId});\n});\n\nvar api = new Restivus({\n\tuseDefaultAuth: true,\n\tauth: {\n\t\ttoken: 'auth.apiKey'\n\t}\n});\n\nMeteor.methods({\n\tupdateUsername(username) {\n\t\tMeteor.users.update({_id:Meteor.userId()}, {$set:{username:username, 'emails.0.address':username}});\n\t},\n\tuploadProfilePicture(args) {\n\t\tif (Meteor.user()) {\n\t\t\tHTTP.post(Meteor.settings.public.imageServerUrl + '/upload.php', {\n\t\t\t\tcontent:args.data\n\t\t\t}, (err, result) => {\n\t\t\t\tif (result.data.result == 'success') {\n\t\t\t\t\tMeteor.users.update({_id:Meteor.userId()}, {$set:{'profile.picture':result.data.url}});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n});\n\napi.addCollection(Meteor.users);\napi.addCollection(Surveys);\n\napi.addRoute('delivery/calendar', {\n\tpost: function() {\n\t\tvar userId = this.request.headers['x-user-id']\n\t\tvar order = resolveOrder(this.bodyParams.order, userId);\n\t\tvar [, year, month] = this.queryParams.month.match(/(\\d{4})-(\\d{1,2})/);\n\t\tvar timeSlots = timeSlotsForMonth(new Date(year, month - 1));\n\t\tvar availabilityDates = availablilityDatesForOrder(order);\n\n\t\tvar response = {};\n\t\tfor (var date in timeSlots) {\n\t\t\tif (availabilityDates.test(date)) {\n\t\t\t\tresponse[date] = timeSlots[date];\n\t\t\t}\n\t\t\telse {\n\t\t\t\tresponse[date] = [];\n\t\t\t}\n\t\t}\n\t\treturn response;\n\t}\n});\n\napi.addRoute('users/delivery-addresses', {\n\tpost() {\n\t\tMeteor.users.update({_id:this.request.headers['x-user-id']}, {$push:{'profile.deliveryAddresses':this.bodyParams}});\n\t\treturn true;\n\t}\n});\n\napi.addRoute('payment/client-token', {\n\tget: function() {\n\t\tvar clientId = this.queryParams.clientId;\n\t\tvar generateToken = Meteor.wrapAsync(gateway.clientToken.generate, gateway.clientToken);\n\t\tvar options = {};\n\n\t\tif (clientId) {\n\t\t\toptions.clientId = clientId;\n\t\t}\n\n\t\tvar response = generateToken(options);\n\n\t\treturn response.clientToken;\n\t}\n});\n\napi.addRoute('users/reset-password', {\n\tget: function() {\n\t\tvar user = Meteor.users.findOne({username:this.queryParams.email.toLowerCase()});\n\t\tif (user) {\n\t\t\tAccounts.sendResetPasswordEmail(user._id);\n\t\t\treturn true;\n\t\t}\n\t\telse {\n\t\t\treturn false;\n\t\t}\n\t}\n});\n\napi.addRoute('promo-codes/validate', {\n\tpost() {\n\t\tvar promotion = Promotions.findOne({promoCode:new RegExp(this.bodyParams.promoCode, 'i')});\n\t\tvar result = validatePromotion(this.request.headers['x-user-id'], this.bodyParams.order, promotion);\n\t\tif (_.isArray(result)) {\n\t\t\treturn {\n\t\t\t\tresult: true,\n\t\t\t\tbundles: result,\n\t\t\t\tpromotion: promotion\n\t\t\t};\n\t\t}\n\t\telse {\n\t\t\treturn {\n\t\t\t\tresult: false,\n\t\t\t\terror: result\n\t\t\t};\n\t\t}\n\t}\n});\n\napi.addRoute('orders', {\n\tpost() {\n\t\tvar orderData = this.bodyParams;\n\t\tvar userId = this.request.headers['x-user-id']\n\t\tlockFile.lockSync('orders.lock');\n\t\tvar response = createOrder(orderData, userId, {\n\t\t\tgateway: gateway,\n\t\t\tcharge: true,\n\t\t\tsendEmails: true,\n\t\t\ttransactions: true\n\t\t});\n\t\tlockFile.unlockSync('orders.lock');\n\t\treturn response;\n\t}\n});\n\napi.addRoute('profile-picture', {\n\tpost() {\n\t\tconsole.log(this.request.files);\n\t\treturn true;\n\t}\n});\n\napi.addRoute('facebook-login', {\n\tget: function() {\n\t\tvar accessToken = this.queryParams.accessToken;\n\t\tvar expiresIn = this.queryParams.expiresIn;\n\n\t\tvar fb = new Facebook({\n\t\t\taccessToken: accessToken,\n\t\t\tappId: Meteor.settings.facebook.appId,\n\t\t\tappSecret: Meteor.settings.facebook.secret,\n\t\t});\n\n\t\tvar serviceData = Meteor.wrapAsync(function(done) {\n\t\t\tfb.api('me', {fields:['id', 'email', 'name', 'first_name', 'last_name']}, function(res) {\n\t\t\t\tdone(null, res);\n\t\t\t});\n\t\t})();\n\n\t\tserviceData.accessToken = accessToken;\n\t\tserviceData.expiresAt = parseInt((+new Date) + (1000 * expiresIn));\n\n\t\tvar userId;\n\t\tvar user = Meteor.users.findOne({username:serviceData.email});\n\n\t\tif (user && !user.services.facebook) {\n\t\t\tMeteor.users.update({_id:user._id}, {\n\t\t\t\t$set: {\n\t\t\t\t\t'services.facebook': serviceData\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\n\t\tif (!user) {\n\t\t\tuser = Meteor.users.findOne({'services.facebook.id':serviceData.id});\n\t\t}\n\n\t\tif (!user) {\n\t\t\tuserId = Accounts.insertUserDoc({}, {\n\t\t\t\tusername: serviceData.email,\n\t\t\t\temails: [{address:serviceData.email, verified:true}],\n\t\t\t\tprofile: {\n\t\t    \tfirstName: serviceData.first_name,\n\t\t    \tsurname: serviceData.last_name,\n\t\t\t\t},\n\t\t\t\tservices: {\n\t\t\t\t\tfacebook: serviceData\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\telse {\n\t\t\tuserId = user._id;\n\t\t}\n\n\t\tvar authToken = Accounts._generateStampedLoginToken();\n\t\tvar hashedToken = Accounts._hashLoginToken(authToken.token);\n\t\tAccounts._insertHashedLoginToken(userId, {\n\t\t  hashedToken: hashedToken\n\t\t});\n\t\treturn {\n\t\t  authToken: authToken.token,\n\t\t  userId: userId\n\t\t};\n\t}\n});\n\napi.addRoute('admin/invoices', {\n\tget: function() {\n\t\tvar wkhtmltopdf = require('wkhtmltopdf');\n\t\tMeteor.wrapAsync((done) => {\n\t\t\twkhtmltopdf(Meteor.settings.public.exportUrl + 'invoice.php?orders=' + this.queryParams.orders, {\n\t\t\t\theaderHtml: Meteor.settings.public.exportUrl + 'invoice-header.html',\n\t\t\t\tfooterHtml: Meteor.settings.public.exportUrl + 'invoice-footer.html',\n\t\t\t}, () => {done()}).pipe(this.response);\n\t\t})();\n\t\tthis.done();\n\t}\n});\n\n\n// ServiceConfiguration.configurations.remove({\n//     service: 'facebook'\n// });\n// ServiceConfiguration.configurations.insert({\n//     service: 'facebook',\n//     appId: '832188753584745',\n//     secret: '178fbaf18a80a823a3ad42026ecd8716'\n// });\n\n\n// function checkOrderStock(order) {\n// \tvar mealStock = {};\n// \tfor (let bundle of order.bundles) {\n// \t\tfor (let mealSelection of bundle.mealSelections) {\n// \t\t\tvar currentStock = Meals.findOne({_id:mealSelection.meal._id}).stock;\n// \t\t\tif (currentStock < mealSelection.quantity) {\n// \t\t\t\tmealStock[mealSelection.meal._id._str] = currentStock;\n// \t\t\t}\n// \t\t}\n// \t}\n// \tif (_.isEmpty(mealStock)) {\n// \t\treturn true;\n// \t}\n// \telse {\n// \t\treturn mealStock;\n// \t}\n// }\n\n// function adjustStock(order) {\n// \tfor (let bundle of order.bundles) {\n// \t\tfor (let mealSelection of bundle.mealSelections) {\n// \t\t\tMeals.update({_id:mealSelection.meal._id}, {$inc:{stock:-mealSelection.quantity}});\n// \t\t}\n// \t}\n// }\n\n"]}